<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Face Looker (Anim Face)</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #ffffff;
      color: #000000;
      overflow: hidden; /* prevent scrolling */
      overscroll-behavior: none; /* prevent bounce/refresh */
      touch-action: none; /* disable default touch gestures */
    }

    .center {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .viewer {
      position: relative;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas#faceCanvas {
      display: block;
      max-width: 25%;
      width: 256px;
      height: auto;
      border-radius: 50%;
      border: 3px solid #cccccc;
      background: #f7f7f7;
    }

    .hint {
      width: 25vw;
      max-width: 256px;
      margin-top: 1rem;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 0.9rem;
      color: #444;
    }
    .repo-link {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 8px;
      text-align: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 0.85rem;
      color: #666;
    }
    .repo-link a {
      color: inherit;
      text-decoration: none;
    }
    .repo-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="center">
    <div class="viewer" id="viewer">
      <canvas id="faceCanvas"></canvas>
      <div class="hint">Move mouse or drag finger to rotate</div>
    </div>
  </div>

  <script>
    // This viewer reads anim-face.json produced by optimize.py (saved in the same folder)
    const MANIFEST_URL = "anim-face.json"; // relative to this HTML file

    const canvas = document.getElementById("faceCanvas");
    const ctx = canvas.getContext("2d");

    fetch(MANIFEST_URL)
      .then((r) => r.json())
      .then((manifest) => {
        const STEP_WIDTH = manifest.step;
        const frameCount = manifest.frameCount;
        const frameWidth = manifest.frameWidth;
        const frameHeight = manifest.frameHeight;
        const columns = manifest.columns;
        const rows = manifest.rows; // not directly needed but useful
        // Resolve sprite path relative to the manifest URL so assets can live in ../out/
        const manifestBase = new URL(MANIFEST_URL, window.location.href);
        const SPRITE_SRC = new URL(manifest.image, manifestBase).toString();

        const sprite = new Image();
        sprite.src = SPRITE_SRC;
        sprite.decoding = "async";
        sprite.onload = () => {
          // Set canvas internal resolution to frame size for crisp rendering
          canvas.width = frameWidth;
          canvas.height = frameHeight;

          // Draw initial frame (0Â°)
          drawFrame(0);

          function angleFromCenter(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dx = clientX - centerX;
            const dy = centerY - clientY; // invert Y so positive is up
            let deg = Math.atan2(dy, dx) * (180 / Math.PI); // -180..180, 0=right, 90=up
            if (deg < 0) deg += 360; // 0..360
            return deg;
          }

          function angleToIndex(deg) {
            const snapped = Math.round(deg / STEP_WIDTH) * STEP_WIDTH;
            const normalized = ((snapped % 360) + 360) % 360;
            const idx = Math.floor(normalized / STEP_WIDTH);
            return Math.min(frameCount - 1, Math.max(0, idx));
          }

          function drawFrameByAngle(deg) {
            const idx = angleToIndex(deg);
            drawFrame(idx);
          }

          function drawFrame(index) {
            const col = index % columns;
            const row = Math.floor(index / columns);
            const sx = col * frameWidth;
            const sy = row * frameHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(sprite, sx, sy, frameWidth, frameHeight, 0, 0, canvas.width, canvas.height);
          }

          function handlePointer(clientX, clientY) {
            const deg = angleFromCenter(clientX, clientY);
            drawFrameByAngle(deg);
          }

          // Whole-page listeners for smooth interaction
          window.addEventListener("mousemove", (e) => handlePointer(e.clientX, e.clientY));
      window.addEventListener(
        "touchstart",
        (e) => {
          if (e.touches && e.touches.length > 0) {
            e.preventDefault();
            const t = e.touches[0];
            handlePointer(t.clientX, t.clientY);
          }
        },
        { passive: false }
      );
      window.addEventListener(
        "touchmove",
        (e) => {
          if (e.touches && e.touches.length > 0) {
            e.preventDefault();
            const t = e.touches[0];
            handlePointer(t.clientX, t.clientY);
          }
        },
        { passive: false }
      );
        };
      });
  </script>
  <div class="repo-link">
    <a href="https://github.com/alexanderthurn/optimized-face-looker" target="_blank" rel="noopener noreferrer">https://github.com/alexanderthurn/optimized-face-looker</a>
  </div>
</body>
</html>
